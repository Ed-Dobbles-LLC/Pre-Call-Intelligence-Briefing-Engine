<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pre-Call Intelligence Briefing Engine</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg-primary: #0a0b10;
      --bg-secondary: #111318;
      --bg-card: #161922;
      --bg-card-hover: #1c1f2c;
      --bg-input: #1e2130;
      --border: #252839;
      --border-light: #2e3148;
      --text-primary: #e8eaf0;
      --text-secondary: #9196ab;
      --text-muted: #5d6280;
      --accent: #7c5cfc;
      --accent-light: #9b82fc;
      --accent-glow: rgba(124, 92, 252, 0.12);
      --accent-gradient: linear-gradient(135deg, #7c5cfc 0%, #5c8afc 100%);
      --success: #34d399;
      --success-bg: rgba(52, 211, 153, 0.1);
      --warning: #fbbf24;
      --warning-bg: rgba(251, 191, 36, 0.1);
      --danger: #f87171;
      --danger-bg: rgba(248, 113, 113, 0.1);
      --info: #60a5fa;
      --info-bg: rgba(96, 165, 250, 0.1);
      --confidence-low: #f87171;
      --confidence-med: #fbbf24;
      --confidence-high: #34d399;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 20px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* ── Top Nav ── */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      height: 60px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(12px);
    }
    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 16px;
      letter-spacing: -0.02em;
    }
    .topbar-brand .brand-icon {
      width: 32px;
      height: 32px;
      background: var(--accent-gradient);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .topbar-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .nav-tab {
      padding: 8px 16px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .nav-tab:hover { color: var(--text-primary); background: var(--bg-card); }
    .nav-tab.active {
      color: var(--text-primary);
      background: var(--bg-card);
    }
    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 16px;
      right: 16px;
      height: 2px;
      background: var(--accent-gradient);
      border-radius: 1px;
    }
    .nav-tab .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      background: var(--accent);
      color: #fff;
      border-radius: 9px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 6px;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .topbar-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 12px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .status-dot.ok { background: var(--success); box-shadow: 0 0 8px var(--success); }
    .status-dot.warn { background: var(--warning); }
    .status-dot.err { background: var(--danger); }

    /* ── Main Container ── */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px;
    }
    @media (max-width: 768px) { .container { padding: 16px; } }

    /* ── Page Views ── */
    .page-view { display: none; }
    .page-view.active { display: block; }

    /* ── Welcome / Home Page ── */
    .welcome-hero {
      text-align: center;
      padding: 48px 0 40px;
    }
    .welcome-hero h1 {
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }
    .welcome-hero h1 .gradient-text {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .welcome-hero p {
      color: var(--text-secondary);
      font-size: 16px;
      max-width: 520px;
      margin: 0 auto;
    }

    /* ── Stats Cards ── */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      transition: all 0.2s;
    }
    .stat-card:hover {
      border-color: var(--border-light);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .stat-card-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-card-icon.purple { background: var(--accent-glow); color: var(--accent); }
    .stat-card-icon.green { background: var(--success-bg); color: var(--success); }
    .stat-card-icon.blue { background: var(--info-bg); color: var(--info); }
    .stat-card-icon.amber { background: var(--warning-bg); color: var(--warning); }
    .stat-card-value {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-card-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* ── Service Status Cards ── */
    .services-section {
      margin-bottom: 32px;
    }
    .section-heading {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    .services-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }
    .service-card {
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px 20px;
      transition: all 0.2s;
    }
    .service-card:hover { border-color: var(--border-light); }
    .service-icon {
      width: 42px;
      height: 42px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 20px;
    }
    .service-icon.fireflies { background: linear-gradient(135deg, #ff6b35 0%, #ff9f1c 100%); }
    .service-icon.gmail { background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%); }
    .service-icon.openai { background: linear-gradient(135deg, #10a37f 0%, #1ed760 100%); }
    .service-icon.database { background: linear-gradient(135deg, #336791 0%, #60a5fa 100%); }
    .service-icon.apollo { background: linear-gradient(135deg, #6c3ce9 0%, #a78bfa 100%); }
    .service-info { flex: 1; min-width: 0; }
    .service-name { font-weight: 600; font-size: 14px; }
    .service-status {
      font-size: 12px;
      margin-top: 2px;
    }
    .service-status.connected { color: var(--success); }
    .service-status.disconnected { color: var(--text-muted); }

    /* ── Next Steps ── */
    .next-steps {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 32px;
    }
    .next-step-item {
      display: flex;
      align-items: center;
      gap: 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .next-step-item:hover {
      border-color: var(--accent);
      background: var(--bg-card-hover);
      transform: translateX(4px);
    }
    .next-step-icon {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .next-step-content { flex: 1; min-width: 0; }
    .next-step-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .next-step-meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    .next-step-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 99px;
      flex-shrink: 0;
    }
    .next-step-empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 14px;
    }

    /* ── Auto-sync Banner ── */
    .sync-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px 24px;
      margin-bottom: 32px;
    }
    .sync-banner-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .sync-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }
    .sync-indicator .pulse {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
      position: relative;
    }
    .sync-indicator .pulse::before {
      content: '';
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      border: 2px solid var(--success);
      animation: pulse-ring 2s ease-out infinite;
    }
    @keyframes pulse-ring {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.5); }
    }
    .sync-indicator.inactive .pulse {
      background: var(--text-muted);
    }
    .sync-indicator.inactive .pulse::before {
      display: none;
    }
    .sync-meta {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .btn-sync {
      padding: 8px 20px;
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-sync:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-sync:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-sync .spinner-sm {
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    /* ── Profiles Page ── */
    .profiles-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .profiles-header h2 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .search-box {
      position: relative;
      width: 300px;
    }
    .search-box input {
      width: 100%;
      padding: 9px 12px 9px 36px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.15s;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .search-box input::placeholder { color: var(--text-muted); }
    .search-box svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }

    .profiles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 16px;
    }
    .profile-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .profile-card:hover {
      border-color: var(--border-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    .profile-card-top {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 16px;
    }
    .profile-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      flex-shrink: 0;
    }
    .profile-info { flex: 1; min-width: 0; }
    .profile-name {
      font-size: 16px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .profile-company {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 1px;
    }
    .profile-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 14px;
    }
    .profile-tag {
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    .profile-tag.meetings { background: var(--info-bg); color: var(--info); }
    .profile-tag.emails { background: var(--accent-glow); color: var(--accent-light); }
    .profile-tag.health-good { background: var(--success-bg); color: var(--success); }
    .profile-tag.health-neutral { background: var(--warning-bg); color: var(--warning); }
    .profile-tag.health-cold { background: var(--danger-bg); color: var(--danger); }
    .profile-tag.verified { background: var(--success-bg); color: var(--success); display: inline-flex; align-items: center; gap: 3px; }
    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--success);
      font-weight: 500;
    }
    .deep-profile-content {
      padding: 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-primary);
      max-height: 60vh;
      overflow-y: auto;
    }
    .deep-profile-content h2 { font-size: 17px; font-weight: 700; margin: 24px 0 10px; color: var(--accent-light); }
    .deep-profile-content h2:first-child { margin-top: 0; }
    .deep-profile-content h3 { font-size: 15px; font-weight: 600; margin: 18px 0 8px; color: var(--text-primary); }
    .deep-profile-content h4 { font-size: 14px; font-weight: 600; margin: 14px 0 6px; color: var(--text-secondary); }
    .deep-profile-content ul, .deep-profile-content ol { padding-left: 20px; margin: 8px 0; }
    .deep-profile-content li { margin-bottom: 4px; }
    .deep-profile-content blockquote { border-left: 3px solid var(--accent); padding: 8px 16px; margin: 12px 0; background: var(--accent-glow); border-radius: 0 var(--radius-sm) var(--radius-sm) 0; font-style: italic; color: var(--text-secondary); }
    .deep-profile-content strong { color: var(--text-primary); }
    .deep-profile-content p { margin: 8px 0; }
    .deep-profile-content code { background: var(--bg-input); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .deep-profile-content table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
    .deep-profile-content th, .deep-profile-content td { border: 1px solid var(--border); padding: 6px 10px; text-align: left; }
    .deep-profile-content th { background: var(--bg-input); font-weight: 600; color: var(--text-primary); }
    .hidden { display: none !important; }
    .btn-research {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }
    .btn-research:hover { opacity: 0.9; }
    .btn-research:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-research-secondary {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: var(--bg-input);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-research-secondary:hover { color: var(--text-primary); border-color: var(--border-light); }
    .loading-spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .profile-stats {
      display: flex;
      gap: 16px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    .profile-stat {
      display: flex;
      flex-direction: column;
    }
    .profile-stat-value {
      font-size: 16px;
      font-weight: 600;
    }
    .profile-stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ── Generate Brief Page ── */
    .brief-page-layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      min-height: calc(100vh - 156px);
    }
    @media (max-width: 900px) {
      .brief-page-layout { grid-template-columns: 1fr; }
    }

    .brief-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      overflow: hidden;
    }
    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-secondary);
    }
    .card-body { padding: 24px; }

    /* ── Form ── */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    .form-group input::placeholder { color: var(--text-muted); }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
    }
    .toggle-row label { margin-bottom: 0; }
    .toggle {
      position: relative;
      width: 40px;
      height: 22px;
    }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      left: 2px;
      top: 2px;
      background: var(--text-secondary);
      border-radius: 50%;
      transition: transform 0.2s, background 0.2s;
    }
    .toggle input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
    .toggle input:checked + .toggle-slider::before { transform: translateX(18px); background: #fff; }

    .btn-generate {
      width: 100%;
      padding: 12px;
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(124, 92, 252, 0.3);
    }
    .btn-generate:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124, 92, 252, 0.4); }
    .btn-generate:active { transform: scale(0.98); }
    .btn-generate:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Recent briefs list ── */
    .recent-list { list-style: none; }
    .recent-item {
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 4px;
      border: 1px solid transparent;
    }
    .recent-item:hover { background: var(--bg-input); }
    .recent-item.active { background: var(--accent-glow); border-color: rgba(124, 92, 252, 0.25); }
    .recent-item-title {
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .recent-item-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 11px;
    }
    .confidence-badge.high { background: rgba(52,211,153,0.12); color: var(--confidence-high); }
    .confidence-badge.med  { background: rgba(251,191,36,0.12); color: var(--confidence-med); }
    .confidence-badge.low  { background: rgba(248,113,113,0.12); color: var(--confidence-low); }
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ── Main Brief panel ── */
    .brief-main { position: relative; }

    .brief-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    .brief-toolbar-actions {
      display: flex;
      gap: 8px;
    }
    .btn-toolbar {
      padding: 7px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-toolbar:hover { background: var(--bg-input); color: var(--text-primary); border-color: var(--border-light); }

    .tab-bar {
      display: flex;
      gap: 4px;
      background: var(--bg-card);
      border-radius: var(--radius-sm);
      padding: 3px;
      border: 1px solid var(--border);
    }
    .tab-btn {
      padding: 6px 16px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 13px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .tab-btn.active { background: var(--accent); color: #fff; }
    .tab-btn:hover:not(.active) { background: var(--bg-input); color: var(--text-primary); }

    /* ── Brief content ── */
    .brief-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      min-height: 300px;
    }
    .brief-content.empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 500px;
    }
    .empty-icon { margin-bottom: 20px; opacity: 0.2; }
    .empty-title { font-size: 18px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .empty-subtitle { font-size: 14px; color: var(--text-muted); max-width: 360px; text-align: center; line-height: 1.6; }

    /* ── Confidence meter ── */
    .confidence-meter {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }
    .meter-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-input);
      border-radius: 3px;
      overflow: hidden;
    }
    .meter-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.6s ease-out, background 0.3s;
    }
    .meter-label { font-size: 14px; font-weight: 700; min-width: 42px; text-align: right; }
    .meter-caption { font-size: 12px; color: var(--text-muted); }

    /* ── Markdown rendering ── */
    .md-render h1 { font-size: 22px; font-weight: 700; margin: 0 0 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .md-render h2 { font-size: 17px; font-weight: 600; margin: 28px 0 12px; color: var(--accent-light); }
    .md-render h3 { font-size: 15px; font-weight: 600; margin: 20px 0 8px; }
    .md-render p { margin: 8px 0; color: var(--text-primary); }
    .md-render ul, .md-render ol { padding-left: 20px; margin: 8px 0; }
    .md-render li { margin: 4px 0; }
    .md-render table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; }
    .md-render th {
      text-align: left;
      padding: 10px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    .md-render td { padding: 10px 14px; border: 1px solid var(--border); }
    .md-render code { background: var(--bg-input); padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .md-render em { color: var(--text-secondary); }
    .md-render strong { color: #fff; }
    .md-render hr { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

    .json-render {
      white-space: pre-wrap;
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.5;
      color: var(--text-primary);
    }
    .json-render .key { color: var(--accent-light); }
    .json-render .string { color: var(--success); }
    .json-render .number { color: var(--warning); }
    .json-render .boolean { color: var(--danger); }
    .json-render .null { color: var(--text-muted); }

    /* ── Profile Detail Modal ── */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 200;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.visible { display: flex; align-items: center; justify-content: center; }
    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 780px;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 24px 28px;
      border-bottom: 1px solid var(--border);
    }
    .modal-header h3 {
      font-size: 18px;
      font-weight: 700;
    }
    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }
    .modal-close:hover { color: var(--text-primary); border-color: var(--border-light); }
    .modal-body { padding: 28px; }
    .modal-section {
      margin-bottom: 24px;
    }
    .modal-section h4 {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .interaction-item {
      padding: 14px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
    }
    .interaction-item-title {
      font-weight: 500;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .interaction-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    .interaction-item-summary {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 8px;
      line-height: 1.5;
    }

    /* ── Toast ── */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      background: #dc2626;
      color: #fff;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      box-shadow: var(--shadow-lg);
      transform: translateY(80px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 300;
    }
    .toast.visible { transform: translateY(0); opacity: 1; }
    .toast.success { background: #059669; }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* ── Contact Links ── */
    .contact-links {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    .contact-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--accent-light);
      text-decoration: none;
      padding: 2px 8px;
      border-radius: 99px;
      background: var(--accent-glow);
      transition: all 0.15s;
    }
    .contact-link:hover {
      background: rgba(124, 92, 252, 0.25);
      color: #fff;
    }
    .contact-link svg { flex-shrink: 0; }

    /* ── Gravatar avatar ── */
    .profile-avatar-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    /* ── LinkedIn Review Page ── */
    .review-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }
    .review-header h2 {
      font-size: 22px;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    .review-count {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .review-list {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .review-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
    }
    .review-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .review-card-info { flex: 1; min-width: 0; }
    .review-card-name {
      font-size: 18px;
      font-weight: 600;
    }
    .review-card-meta {
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .review-label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    .candidates-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .candidate-card {
      background: var(--bg-secondary);
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .candidate-card:hover {
      border-color: var(--accent);
      background: var(--bg-card-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    .candidate-card.selected {
      border-color: var(--accent);
      background: var(--accent-glow);
    }
    .candidate-top {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    .candidate-name {
      font-size: 14px;
      font-weight: 600;
    }
    .candidate-title {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 1px;
    }
    .candidate-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .candidate-detail {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .candidate-li-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--accent-light);
      text-decoration: none;
      margin-top: 8px;
    }
    .candidate-li-link:hover { color: #fff; }
    .review-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    .btn-confirm {
      padding: 8px 20px;
      background: var(--accent-gradient);
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-confirm:hover { opacity: 0.9; }
    .btn-confirm:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-none {
      padding: 8px 20px;
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-none:hover { color: var(--text-primary); border-color: var(--border-light); }
    .search-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .search-row input {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
    }
    .search-row input::placeholder { color: var(--text-muted); }
    .search-row input:focus { outline: none; border-color: var(--accent); }
    .search-row button {
      padding: 8px 16px;
      background: var(--bg-card-hover);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.15s;
    }
    .search-row button:hover { border-color: var(--accent); }
    .search-row button:disabled { opacity: 0.4; cursor: not-allowed; }
    .manual-or { color: var(--text-muted); font-size: 12px; margin-top: 12px; text-transform: uppercase; letter-spacing: 0.05em; }
    .review-empty {
      text-align: center;
      padding: 80px 16px;
    }

    /* ── Utility ── */
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .avatar-colors-0 { background: linear-gradient(135deg, #7c5cfc, #5c8afc); color: #fff; }
    .avatar-colors-1 { background: linear-gradient(135deg, #f97316, #fbbf24); color: #fff; }
    .avatar-colors-2 { background: linear-gradient(135deg, #ec4899, #f43f5e); color: #fff; }
    .avatar-colors-3 { background: linear-gradient(135deg, #10b981, #34d399); color: #fff; }
    .avatar-colors-4 { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: #fff; }
    .avatar-colors-5 { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: #fff; }
  </style>
</head>
<body>

  <!-- Top bar -->
  <nav class="topbar">
    <div class="topbar-brand">
      <div class="brand-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
        </svg>
      </div>
      Pre-Call Intelligence
    </div>

    <div class="topbar-nav">
      <button class="nav-tab active" onclick="showPage('home')" id="navHome">Home</button>
      <button class="nav-tab" onclick="showPage('profiles')" id="navProfiles">
        Profiles
        <span class="badge" id="profilesBadge" style="display:none">0</span>
      </button>
      <button class="nav-tab" onclick="showPage('review')" id="navReview">
        Review
        <span class="badge" id="reviewBadge" style="display:none">0</span>
      </button>
      <button class="nav-tab" onclick="showPage('generate')" id="navGenerate">Generate Brief</button>
    </div>

    <div class="topbar-right">
      <div class="topbar-status" id="healthStatus">
        <span class="status-dot" id="healthDot"></span>
        <span id="healthText">Connecting...</span>
      </div>
    </div>
  </nav>

  <!-- ═══════════════════ HOME PAGE ═══════════════════ -->
  <div class="page-view active" id="pageHome">
    <div class="container">

      <div class="welcome-hero">
        <h1>Welcome to <span class="gradient-text">Pre-Call Intelligence</span></h1>
        <p>Automatically analyze your Fireflies transcripts to build rich contact profiles and generate decision-grade pre-call briefs.</p>
      </div>

      <!-- Stats -->
      <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon purple">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </div>
          </div>
          <div class="stat-card-value" id="statProfiles">--</div>
          <div class="stat-card-label">Contact Profiles</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon green">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            </div>
          </div>
          <div class="stat-card-value" id="statTranscripts">--</div>
          <div class="stat-card-label">Transcripts Synced</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon blue">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            </div>
          </div>
          <div class="stat-card-value" id="statBriefs">--</div>
          <div class="stat-card-label">Briefs Generated</div>
        </div>
        <div class="stat-card">
          <div class="stat-card-header">
            <div class="stat-card-icon amber">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
          </div>
          <div class="stat-card-value" id="statLastSync">--</div>
          <div class="stat-card-label">Last Sync</div>
        </div>
      </div>

      <!-- Auto-sync Banner -->
      <div class="sync-banner">
        <div class="sync-banner-left">
          <div class="sync-indicator" id="syncIndicator">
            <div class="pulse"></div>
            <span id="syncStatusText">Auto-sync active</span>
          </div>
          <div class="sync-meta" id="syncMeta">Profiles update automatically from Fireflies transcripts</div>
        </div>
        <button class="btn-sync" id="syncNowBtn" onclick="triggerSync()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
          Sync Now
        </button>
      </div>

      <!-- Connected Services -->
      <div class="services-section">
        <div class="section-heading">Connected Services</div>
        <div class="services-grid" id="servicesGrid">
          <div class="service-card">
            <div class="service-icon fireflies">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="white" stroke="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            </div>
            <div class="service-info">
              <div class="service-name">Fireflies.ai</div>
              <div class="service-status" id="svcFireflies">Checking...</div>
            </div>
          </div>
          <div class="service-card">
            <div class="service-icon gmail">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            </div>
            <div class="service-info">
              <div class="service-name">Gmail</div>
              <div class="service-status" id="svcGmail">Checking...</div>
            </div>
          </div>
          <div class="service-card">
            <div class="service-icon openai">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
            </div>
            <div class="service-info">
              <div class="service-name">OpenAI</div>
              <div class="service-status" id="svcOpenAI">Checking...</div>
            </div>
          </div>
          <div class="service-card">
            <div class="service-icon apollo">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <div class="service-info">
              <div class="service-name">Apollo.io</div>
              <div class="service-status" id="svcApollo">Checking...</div>
            </div>
          </div>
          <div class="service-card">
            <div class="service-icon database">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
            </div>
            <div class="service-info">
              <div class="service-name" id="svcDbName">Database</div>
              <div class="service-status" id="svcDatabase">Checking...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Next Steps (dynamically populated from contact data) -->
      <div class="section-heading">Next Steps</div>
      <div class="next-steps" id="nextStepsContainer">
        <div class="next-step-empty">Loading next steps...</div>
      </div>

    </div>
  </div>

  <!-- ═══════════════════ PROFILES PAGE ═══════════════════ -->
  <div class="page-view" id="pageProfiles">
    <div class="container">
      <div class="profiles-header">
        <h2>Contact Profiles</h2>
        <div style="display:flex;align-items:center;gap:10px">
          <button class="btn-sync" id="refreshPhotosBtn" onclick="refreshPhotos()" style="font-size:12px;padding:6px 12px" title="Re-fetch photos from Apollo for verified contacts missing pictures">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
            Refresh Photos
          </button>
          <div class="search-box">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" placeholder="Search profiles..." id="profileSearch" oninput="filterProfiles()" />
          </div>
        </div>
      </div>
      <div class="profiles-grid" id="profilesGrid">
        <div class="empty-state" style="grid-column: 1/-1; padding: 80px 16px;">
          <div style="margin-bottom: 12px; opacity: 0.3;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </div>
          <div class="empty-title">No profiles yet</div>
          <div class="empty-subtitle">Click "Sync Now" on the Home page to pull transcripts from Fireflies and auto-build contact profiles.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════ LINKEDIN REVIEW PAGE ═══════════════════ -->
  <div class="page-view" id="pageReview">
    <div class="container">
      <div class="review-header">
        <h2>LinkedIn Profile Review</h2>
        <div class="review-count" id="reviewCount"></div>
      </div>
      <div class="review-list" id="reviewList">
        <div class="review-empty">
          <div style="margin-bottom: 12px; opacity: 0.3;">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/></svg>
          </div>
          <div class="empty-title">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════ GENERATE BRIEF PAGE ═══════════════════ -->
  <div class="page-view" id="pageGenerate">
    <div class="container">
      <div class="brief-page-layout">

        <!-- Sidebar -->
        <div class="brief-sidebar">
          <div class="card">
            <div class="card-header">Generate Brief</div>
            <div class="card-body">
              <form id="briefForm" onsubmit="return false;">
                <div class="form-group">
                  <label for="person">Person</label>
                  <input type="text" id="person" placeholder="e.g. Jane Doe" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="company">Company</label>
                  <input type="text" id="company" placeholder="e.g. Acme Corp" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="topic">Topic</label>
                  <input type="text" id="topic" placeholder="e.g. Q1 Pipeline Review" autocomplete="off" />
                </div>
                <div class="form-group">
                  <label for="meetingWhen">Meeting Date/Time</label>
                  <input type="datetime-local" id="meetingWhen" />
                </div>
                <div class="form-group">
                  <div class="toggle-row">
                    <label for="skipIngestion" style="font-size:13px;color:var(--text-secondary)">Skip live ingestion</label>
                    <label class="toggle">
                      <input type="checkbox" id="skipIngestion" />
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
                <button class="btn-generate" id="generateBtn" onclick="generateBrief()">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                  Generate Brief
                </button>
              </form>
            </div>
          </div>

          <div class="card" style="flex:1; overflow-y: auto;">
            <div class="card-header">Recent Briefs</div>
            <div class="card-body" style="padding: 12px;">
              <ul class="recent-list" id="recentList">
                <li class="empty-state">Loading...</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <div class="brief-main">
          <div id="briefToolbar" class="brief-toolbar" style="display:none">
            <div class="tab-bar">
              <button class="tab-btn active" onclick="switchView('rendered')" id="tabRendered">Rendered</button>
              <button class="tab-btn" onclick="switchView('json')" id="tabJson">JSON</button>
            </div>
            <div class="brief-toolbar-actions">
              <button class="btn-toolbar" onclick="copyBrief()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                Copy
              </button>
              <button class="btn-toolbar" onclick="downloadBrief()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download
              </button>
            </div>
          </div>

          <!-- Empty state -->
          <div class="brief-content empty" id="emptyState">
            <div class="empty-icon">
              <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
              </svg>
            </div>
            <div class="empty-title">No brief loaded</div>
            <div class="empty-subtitle">Fill in a person or company on the left and hit Generate to create a pre-call intelligence brief.</div>
          </div>

          <!-- Confidence meter (hidden) -->
          <div id="confidenceMeter" class="confidence-meter" style="display:none">
            <div><div class="meter-caption">Confidence</div></div>
            <div class="meter-bar"><div class="meter-fill" id="meterFill" style="width:0%"></div></div>
            <div class="meter-label" id="meterLabel">0%</div>
          </div>

          <!-- Brief views -->
          <div class="brief-content md-render" id="renderedView" style="display:none"></div>
          <div class="brief-content json-render" id="jsonView" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ═══════════════════ PROFILE DETAIL MODAL ═══════════════════ -->
  <div class="modal-overlay" id="profileModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modalProfileName">Profile</h3>
        <button class="modal-close" onclick="closeProfileModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="modal-body" id="modalProfileBody">
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ── State ──
    let currentBrief = null;
    let currentMarkdown = '';
    let currentView = 'rendered';
    let allProfiles = [];
    const API_BASE = '';
    // API key read from ?key= query param or localStorage
    const apiKey = new URLSearchParams(window.location.search).get('key')
                   || localStorage.getItem('briefing_api_key')
                   || '';

    function authHeaders() {
      return apiKey ? { 'Authorization': 'Bearer ' + apiKey } : {};
    }

    // ── Helpers ──
    function $(id) { return document.getElementById(id); }

    function showToast(msg, type = 'error', duration = 4000) {
      const t = $('toast');
      t.textContent = msg;
      t.className = 'toast visible' + (type === 'success' ? ' success' : '');
      setTimeout(() => t.className = 'toast', duration);
    }

    function confidenceClass(score) {
      if (score >= 0.6) return 'high';
      if (score >= 0.3) return 'med';
      return 'low';
    }

    function confidenceColor(score) {
      if (score >= 0.6) return 'var(--confidence-high)';
      if (score >= 0.3) return 'var(--confidence-med)';
      return 'var(--confidence-low)';
    }

    function formatDate(iso) {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatRelative(iso) {
      if (!iso) return 'Never';
      const d = new Date(iso);
      const now = new Date();
      const diff = now - d;
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'Just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      if (days < 7) return days + 'd ago';
      return formatDate(iso);
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
    }

    function avatarClass(name) {
      if (!name) return 'avatar-colors-0';
      let hash = 0;
      for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
      return 'avatar-colors-' + (Math.abs(hash) % 6);
    }

    // Minimal MD5 for Gravatar (standard implementation)
    function md5(s){function L(k,d){return(k<<d)|(k>>>(32-d))}function K(G,k){var I,d,F,H,x;F=(G&2147483648);H=(k&2147483648);I=(G&1073741824);d=(k&1073741824);x=(G&1073741823)+(k&1073741823);if(I&d)return(x^2147483648^F^H);if(I|d){if(x&1073741824)return(x^3221225472^F^H);else return(x^1073741824^F^H)}else return(x^F^H)}function r(d,F,k){return(d&F)|((~d)&k)}function q(d,F,k){return(d&k)|(F&(~k))}function p(d,F,k){return(d^F^k)}function n(d,F,k){return(F^(d|(~k)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(G){var Z;var F=G.length;var x=F+8;var k=(x-(x%64))/64;var I=(k+1)*16;var aa=Array(I-1);var d=0;var H=0;while(H<F){Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=(aa[Z]|(G.charCodeAt(H)<<d));H++}Z=(H-(H%4))/4;d=(H%4)*8;aa[Z]=aa[Z]|(128<<d);aa[I-2]=F<<3;aa[I-1]=F>>>29;return aa}function B(x){var k="",F="",G,d;for(d=0;d<=3;d++){G=(x>>>(d*8))&255;F="0"+G.toString(16);k=k+F.substr(F.length-2,2)}return k}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=function(x){var k=[];for(var d=0;d<x.length;d++){var F=x.charCodeAt(d);if(F<128)k.push(F);else if(F<2048){k.push(192|F>>6);k.push(128|F&63)}else{k.push(224|F>>12);k.push(128|F>>6&63);k.push(128|F&63)}}return String.fromCharCode.apply(null,k)}(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}return(B(Y)+B(X)+B(W)+B(V)).toLowerCase()}

    function getGravatarUrl(email, size) {
      if (!email) return null;
      const hash = md5(email.trim().toLowerCase());
      return 'https://www.gravatar.com/avatar/' + hash + '?s=' + (size || 80) + '&d=404';
    }

    function getCandidatePhoto(profile) {
      // For pending_review profiles, show the recommended candidate's photo as preview
      if (!profile || !profile.linkedin_candidates || !profile.linkedin_candidates.length) return '';
      const rec = profile.linkedin_candidates.find(c => c.recommended);
      if (rec && rec.photo_url) return rec.photo_url;
      // Fall back to first candidate with a photo
      for (const c of profile.linkedin_candidates) {
        if (c.photo_url) return c.photo_url;
      }
      return '';
    }

    function avatarFallback(img) {
      const fallbacks = (img.dataset.fallbacks || '').split('|').filter(Boolean);
      if (fallbacks.length) {
        img.src = fallbacks[0];
        img.dataset.fallbacks = fallbacks.slice(1).join('|');
      } else {
        img.remove();
      }
    }

    // Track which contact photos rendered successfully (client-side)
    const photoRenderStatus = {};

    function avatarHtml(name, email, size, photoUrl, linkedinUrl, contactId) {
      size = size || 40;
      const initials = getInitials(name);
      const colorCls = avatarClass(name);
      // Photo Resolution: NEVER block existing photo_url.
      // Render as-is with robust fallback chain on error.
      // 1. Existing photo_url (even LinkedIn CDN — let browser try)
      // 2. Gravatar (email hash)
      // 3. Clearbit company logo (domain fallback)
      // 4. Initials (always works)
      const sources = [];
      if (photoUrl) sources.push(photoUrl);
      // Gravatar: reliable, privacy-respecting, always available
      const gravatar = getGravatarUrl(email, size * 2);
      if (gravatar) sources.push(gravatar);
      // Clearbit company logo as domain fallback
      if (email && email.includes('@')) {
        const domain = email.split('@')[1].toLowerCase();
        const freeProviders = ['gmail.com','yahoo.com','hotmail.com','outlook.com','live.com','icloud.com','aol.com','protonmail.com'];
        if (!freeProviders.includes(domain)) {
          sources.push('https://logo.clearbit.com/' + domain + '?size=' + (size * 2));
        }
      }
      if (sources.length) {
        const fallbacks = sources.slice(1).join('|');
        const cid = contactId || 0;
        return `<div class="profile-avatar ${colorCls}" style="width:${size}px;height:${size}px;font-size:${Math.round(size*0.4)}px">
          <img class="profile-avatar-img" src="${sources[0]}" alt="" data-fallbacks="${fallbacks}" data-contact-id="${cid}" onload="photoRenderStatus[${cid}]=true" onerror="avatarFallbackWithReport(this)">${initials}</div>`;
      }
      return `<div class="profile-avatar ${colorCls}" style="width:${size}px;height:${size}px;font-size:${Math.round(size*0.4)}px">${initials}</div>`;
    }

    function avatarFallbackWithReport(img) {
      // If the original photo_url failed (first source), report FAILED_RENDER to server
      const contactId = img.dataset.contactId;
      const fallbacks = (img.dataset.fallbacks || '').split('|').filter(Boolean);
      if (contactId && contactId !== '0' && !img.dataset.reportedFail) {
        img.dataset.reportedFail = 'true';
        photoRenderStatus[contactId] = false;
        fetch('/profiles/' + contactId + '/photo-render-failed', {
          method: 'POST',
          headers: apiKey ? {'Authorization': 'Bearer ' + apiKey} : {},
        }).catch(() => {});
      }
      // Continue with fallback chain
      avatarFallback(img);
    }

    function contactLinksHtml(email, name, company, linkedinUrl) {
      let html = '';
      if (email) {
        html += `<a class="contact-link" href="mailto:${email}" onclick="event.stopPropagation()" title="Send email">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
          Email</a>`;
      }
      // Use real LinkedIn URL from Apollo if available, otherwise search
      const liUrl = linkedinUrl || ('https://www.linkedin.com/search/results/people/?keywords=' + encodeURIComponent([name, company].filter(Boolean).join(' ')));
      if (name) {
        html += `<a class="contact-link" href="${liUrl}" target="_blank" rel="noopener" onclick="event.stopPropagation()" title="${linkedinUrl ? 'View LinkedIn profile' : 'Search on LinkedIn'}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/></svg>
          LinkedIn</a>`;
      }
      return html ? '<div class="contact-links">' + html + '</div>' : '';
    }

    function syntaxHighlight(json) {
      if (typeof json !== 'string') json = JSON.stringify(json, null, 2);
      return json.replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,
        function (match) {
          let cls = 'number';
          if (/^"/.test(match)) cls = /:$/.test(match) ? 'key' : 'string';
          else if (/true|false/.test(match)) cls = 'boolean';
          else if (/null/.test(match)) cls = 'null';
          return '<span class="' + cls + '">' + match + '</span>';
        }
      );
    }

    // ── Navigation ──
    function showPage(page) {
      document.querySelectorAll('.page-view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      $('page' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');
      $('nav' + page.charAt(0).toUpperCase() + page.slice(1)).classList.add('active');

      if (page === 'profiles') loadProfiles();
      if (page === 'review') loadPendingReviews();
      if (page === 'generate') loadRecent();
    }

    // ── Health check ──
    async function checkHealth() {
      try {
        const res = await fetch(API_BASE + '/health');
        const data = await res.json();

        $('healthDot').className = 'status-dot ' + (data.status === 'ok' ? 'ok' : 'warn');
        $('healthText').textContent = data.status === 'ok' ? 'Online' : 'Degraded';

        // Services
        $('svcFireflies').textContent = data.fireflies_configured ? 'Connected' : 'Not configured';
        $('svcFireflies').className = 'service-status ' + (data.fireflies_configured ? 'connected' : 'disconnected');

        $('svcGmail').textContent = data.gmail_configured ? 'Connected' : 'Not configured';
        $('svcGmail').className = 'service-status ' + (data.gmail_configured ? 'connected' : 'disconnected');

        $('svcOpenAI').textContent = data.openai_configured ? 'Connected' : 'Not configured';
        $('svcOpenAI').className = 'service-status ' + (data.openai_configured ? 'connected' : 'disconnected');

        $('svcApollo').textContent = data.apollo_configured ? 'Connected' : 'Not configured';
        $('svcApollo').className = 'service-status ' + (data.apollo_configured ? 'connected' : 'disconnected');

        const dbLabel = data.database === 'postgres' ? 'PostgreSQL' : 'SQLite';
        $('svcDbName').textContent = dbLabel;
        $('svcDatabase').textContent = 'Connected';
        $('svcDatabase').className = 'service-status connected';

        // Sync indicator
        if (data.fireflies_configured) {
          $('syncIndicator').classList.remove('inactive');
          $('syncStatusText').textContent = 'Auto-sync active';
        } else {
          $('syncIndicator').classList.add('inactive');
          $('syncStatusText').textContent = 'Auto-sync inactive';
          $('syncMeta').textContent = 'Configure Fireflies API key to enable auto-sync';
        }
      } catch (e) {
        $('healthDot').className = 'status-dot err';
        $('healthText').textContent = 'Offline';
      }
    }

    // ── Dashboard Stats ──
    async function loadStats() {
      try {
        const res = await fetch(API_BASE + '/stats', { headers: authHeaders() });
        if (!res.ok) return;
        const data = await res.json();
        $('statProfiles').textContent = data.profiles || 0;
        $('statTranscripts').textContent = data.transcripts || 0;
        $('statBriefs').textContent = data.briefs || 0;
        $('statLastSync').textContent = data.last_sync ? formatRelative(data.last_sync) : 'Never';

        if (data.profiles > 0) {
          $('profilesBadge').style.display = 'inline-flex';
          $('profilesBadge').textContent = data.profiles;
        }
      } catch (e) {}
    }

    // ── Smart Next Steps ──
    async function loadNextSteps() {
      const container = $('nextStepsContainer');
      try {
        const [profilesRes, nextStepsRes] = await Promise.all([
          fetch(API_BASE + '/profiles', { headers: authHeaders() }),
          fetch(API_BASE + '/next-steps', { headers: authHeaders() }).catch(() => null),
        ]);
        if (!profilesRes.ok) throw new Error();
        const profiles = await profilesRes.json();
        const scheduledSteps = nextStepsRes && nextStepsRes.ok ? await nextStepsRes.json() : [];

        if (!profiles.length && !scheduledSteps.length) {
          container.innerHTML = `
            <div class="next-step-item" onclick="triggerSync()">
              <div class="next-step-icon" style="background:var(--info-bg)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              </div>
              <div class="next-step-content">
                <div class="next-step-title">Sync your first transcripts</div>
                <div class="next-step-meta">Pull meetings from Fireflies to build contact profiles</div>
              </div>
            </div>`;
          return;
        }

        const steps = [];

        // 0. Scheduled meetings from email (highest priority)
        scheduledSteps.slice(0, 3).forEach(ns => {
          const personName = ns.person || 'someone';
          steps.push({
            icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>`,
            iconBg: 'var(--info-bg)',
            title: ns.title || 'Upcoming meeting',
            meta: `${ns.person ? 'With ' + ns.person + ' · ' : ''}${formatDate(ns.date)}`,
            badge: 'Scheduled',
            badgeColor: 'var(--info)',
            badgeBg: 'var(--info-bg)',
            action: ns.person ? `$('person').value='${ns.person.replace(/'/g, "\\'")}'; showPage('generate')` : `showPage('generate')`,
          });
        });

        // 1. Cold contacts to re-engage
        const cold = profiles.filter(p => p.relationship_health === 'cold').slice(0, 2);
        cold.forEach(p => {
          steps.push({
            icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>`,
            iconBg: 'var(--danger-bg)',
            title: `Re-engage ${p.name}`,
            meta: `${p.company ? p.company + ' \u00b7 ' : ''}Last contact ${formatRelative(p.last_interaction)}`,
            badge: 'Cold',
            badgeColor: 'var(--danger)',
            badgeBg: 'var(--danger-bg)',
            action: `showPage('profiles')`,
          });
        });

        // 2. Contacts with open action items
        const withItems = profiles.filter(p => (p.action_items_count || 0) > 0 && p.relationship_health !== 'cold').slice(0, 2);
        withItems.forEach(p => {
          steps.push({
            icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--warning)" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
            iconBg: 'var(--warning-bg)',
            title: `${p.action_items_count} open item${p.action_items_count > 1 ? 's' : ''} with ${p.name}`,
            meta: p.action_items && p.action_items[0] ? p.action_items[0].substring(0, 60) + (p.action_items[0].length > 60 ? '...' : '') : '',
            badge: 'Follow up',
            badgeColor: 'var(--warning)',
            badgeBg: 'var(--warning-bg)',
            action: `showPage('profiles')`,
          });
        });

        // 3. Active contacts ready for a brief
        const active = profiles.filter(p => p.relationship_health === 'active' && (p.meeting_count || 0) >= 2).slice(0, 2);
        active.forEach(p => {
          steps.push({
            icon: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            iconBg: 'var(--accent-glow)',
            title: `Prep brief for ${p.name}`,
            meta: `${p.meeting_count} meetings${p.email_count ? ', ' + p.email_count + ' emails' : ''}${p.company ? ' \u00b7 ' + p.company : ''}`,
            badge: 'Ready',
            badgeColor: 'var(--success)',
            badgeBg: 'var(--success-bg)',
            action: `$('person').value='${p.name.replace(/'/g, "\\'")}'; ${p.company ? "$('company').value='" + p.company.replace(/'/g, "\\'") + "';" : ''} showPage('generate')`,
          });
        });

        const shown = steps.slice(0, 6);

        if (!shown.length) {
          container.innerHTML = `
            <div class="next-step-item" onclick="showPage('generate')">
              <div class="next-step-icon" style="background:var(--accent-glow)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
              </div>
              <div class="next-step-content">
                <div class="next-step-title">Generate your first brief</div>
                <div class="next-step-meta">All contacts are up to date. Pick someone and generate a pre-call brief.</div>
              </div>
            </div>`;
          return;
        }

        container.innerHTML = shown.map(s => `
          <div class="next-step-item" onclick="${s.action}">
            <div class="next-step-icon" style="background:${s.iconBg}">${s.icon}</div>
            <div class="next-step-content">
              <div class="next-step-title">${s.title}</div>
              <div class="next-step-meta">${s.meta}</div>
            </div>
            <span class="next-step-badge" style="color:${s.badgeColor};background:${s.badgeBg}">${s.badge}</span>
          </div>
        `).join('');

      } catch (e) {
        container.innerHTML = '<div class="next-step-empty">Could not load next steps</div>';
      }
    }

    // ── Auto-sync / Trigger sync ──
    async function triggerSync() {
      const btn = $('syncNowBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-sm"></span> Syncing...';

      try {
        const res = await fetch(API_BASE + '/sync', { method: 'POST', headers: authHeaders() });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: 'Sync failed' }));
          throw new Error(err.detail);
        }
        const data = await res.json();
        const parts = [`${data.transcripts_synced} transcripts`, `${data.profiles_updated} profiles`];
        if (data.emails_synced) parts.push(`${data.emails_synced} emails`);
        if (data.email_profiles_created) parts.push(`${data.email_profiles_created} new email contacts`);
        if (data.profiles_enriched) parts.push(`${data.profiles_enriched} enriched`);
        showToast(`Synced: ${parts.join(', ')}`, 'success');
        loadStats();
        loadProfiles();
        loadNextSteps();
        loadPendingReviews();
      } catch (e) {
        showToast(e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Sync Now`;
      }
    }

    async function refreshPhotos() {
      const btn = $('refreshPhotosBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-sm"></span> Refreshing...';
      try {
        const res = await fetch(API_BASE + '/profiles/refresh-photos', { method: 'POST', headers: authHeaders() });
        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: 'Refresh failed' }));
          throw new Error(err.detail);
        }
        const data = await res.json();
        if (data.profiles_updated > 0) {
          showToast(`Updated photos for ${data.profiles_updated} profile(s)`, 'success');
          loadProfiles();
        } else {
          showToast('No profiles needed photo updates', 'success');
        }
      } catch (e) {
        showToast(e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg> Refresh Photos`;
      }
    }

    // ── Profiles ──
    async function loadProfiles() {
      try {
        const res = await fetch(API_BASE + '/profiles', { headers: authHeaders() });
        if (!res.ok) return;
        allProfiles = await res.json();
        renderProfiles(allProfiles);
      } catch (e) {}
    }

    function renderProfiles(profiles) {
      const grid = $('profilesGrid');
      if (!profiles.length) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1; padding: 80px 16px;">
            <div style="margin-bottom: 12px; opacity: 0.3;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
            </div>
            <div class="empty-title">No profiles yet</div>
            <div class="empty-subtitle">Click "Sync Now" to pull transcripts from Fireflies and auto-build contact profiles.</div>
          </div>`;
        return;
      }

      grid.innerHTML = profiles.map((p, i) => {
        const health = p.relationship_health || 'neutral';
        const healthLabel = health.charAt(0).toUpperCase() + health.slice(1);
        const healthClass = health === 'active' || health === 'warm' ? 'health-good' :
                           health === 'cold' ? 'health-cold' : 'health-neutral';
        return `
        <div class="profile-card" onclick="openProfileModal(${i})">
          <div class="profile-card-top">
            ${avatarHtml(p.name, p.email, 40, p.photo_url || getCandidatePhoto(p), p.linkedin_url, p.id)}
            <div class="profile-info">
              <div class="profile-name">${p.name}</div>
              <div class="profile-company">${p.title ? p.title + (p.company ? ' @ ' + p.company : '') : (p.company || p.email || 'Unknown')}</div>
              ${contactLinksHtml(p.email, p.name, p.company, p.linkedin_url)}
            </div>
          </div>
          <div class="profile-tags">
            ${p.meeting_count ? '<span class="profile-tag meetings">' + p.meeting_count + ' meeting' + (p.meeting_count > 1 ? 's' : '') + '</span>' : ''}
            ${p.email_count ? '<span class="profile-tag emails">' + p.email_count + ' email' + (p.email_count > 1 ? 's' : '') + '</span>' : ''}
            ${!p.meeting_count && !p.email_count ? '<span class="profile-tag">New</span>' : ''}
            <span class="profile-tag ${healthClass}">${healthLabel}</span>
            ${p.has_upcoming_meeting ? '<span class="profile-tag" style="background:#3b82f620;color:#60a5fa;font-weight:600">Meeting This Week</span>' : ''}
            ${p.linkedin_status === 'pending_review' ? '<span class="profile-tag" style="background:var(--warning-bg);color:var(--warning)">Needs Review</span>' : ''}
            ${p.linkedin_status === 'confirmed' ? '<span class="profile-tag verified"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>Verified</span>' : (p.linkedin_url ? '<span class="profile-tag" style="background:var(--success-bg);color:var(--success)">LinkedIn</span>' : '')}
            ${p.deep_research_status === 'SUCCEEDED' ? '<span class="profile-tag" style="background:var(--success-bg);color:var(--success)">Prepared</span>' : p.dossier_mode_a_markdown ? '<span class="profile-tag" style="background:var(--info-bg);color:var(--info)">Brief Ready</span>' : (!p.deep_profile && p.entity_lock_score < 70) ? '<span class="profile-tag" style="background:var(--warning-bg);color:var(--warning)">Research Needed</span>' : ''}
            ${p.deep_profile ? '<span class="profile-tag" style="background:var(--accent-glow);color:var(--accent-light)">Researched</span>' : ''}
          </div>
          <div class="profile-stats">
            <div class="profile-stat">
              <div class="profile-stat-value">${formatRelative(p.last_interaction)}</div>
              <div class="profile-stat-label">Last Contact</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-value">${p.action_items_count || 0}</div>
              <div class="profile-stat-label">Open Items</div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    function filterProfiles() {
      const q = $('profileSearch').value.toLowerCase();
      if (!q) return renderProfiles(allProfiles);
      renderProfiles(allProfiles.filter(p =>
        (p.name || '').toLowerCase().includes(q) ||
        (p.company || '').toLowerCase().includes(q) ||
        (p.email || '').toLowerCase().includes(q)
      ));
    }

    function openProfileModal(index) {
      const p = allProfiles[index];
      if (!p) return;
      $('modalProfileName').textContent = p.name;

      let html = `
        <div class="modal-section">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px">
            ${avatarHtml(p.name, p.email, 56, p.photo_url || getCandidatePhoto(p), p.linkedin_url, p.id)}
            <div>
              <div style="font-size:20px;font-weight:700">${p.name}</div>
              ${p.title ? '<div style="color:var(--text-primary);font-size:14px">' + p.title + (p.company ? ' @ ' + p.company : '') + '</div>' : (p.company ? '<div style="color:var(--text-secondary)">' + p.company + '</div>' : '')}
              ${p.headline && p.headline !== p.title ? '<div style="color:var(--text-muted);font-size:12px;font-style:italic">' + p.headline + '</div>' : ''}
              ${p.email ? '<div style="color:var(--text-muted);font-size:13px">' + p.email + '</div>' : ''}
              ${p.location ? '<div style="color:var(--text-muted);font-size:12px">' + p.location + '</div>' : ''}
              <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                ${contactLinksHtml(p.email, p.name, p.company, p.linkedin_url)}
                ${p.linkedin_status === 'confirmed' ? '<span class="verified-badge"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> Verified</span>' : ''}
              </div>
            </div>
          </div>
          ${p.company_industry || p.company_size ? '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">' + (p.company_industry ? '<span class="profile-tag meetings">' + p.company_industry + '</span>' : '') + (p.company_size ? '<span class="profile-tag emails">' + p.company_size.toLocaleString() + ' employees</span>' : '') + '</div>' : ''}
          <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn-research" onclick="${p.dossier_mode_a_markdown ? 'scrollToMeetingPrep(' + p.id + ')' : 'generateMeetingPrep(' + p.id + ')'}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              ${p.dossier_mode_a_markdown ? 'View Meeting Prep' : 'Meeting Prep'}
            </button>
            <button class="btn-research-secondary" onclick="${p.deep_profile ? 'scrollToDeepProfile(' + p.id + ')' : 'generateDeepProfile(' + p.id + ')'}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>${p.deep_profile ? 'View Deep Research' : 'Run Deep Research'}</button>
            <button class="btn-research-secondary" onclick="triggerPdfUpload(${p.id})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><polyline points="9 15 12 12 15 15"/></svg>
              ${p.linkedin_pdf_path ? 'Re-upload PDF' : 'Upload LinkedIn PDF'}
            </button>
            ${p.artifact_dossier_markdown ? '<button class="btn-research-secondary" onclick="scrollToArtifactDossier(' + p.id + ')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>View Artifact Dossier</button>' : (p.linkedin_pdf_raw_text ? '<button class="btn-research-secondary" onclick="generateArtifactDossier(' + p.id + ')"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>Generate Artifact Dossier</button>' : '')}
            <button class="btn-research-secondary" onclick="enrichWithPDL(${p.id})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="8"/><line x1="20.5" y1="5.5" x2="20.5" y2="10.5"/></svg>
              ${p.enriched_at ? 'Re-enrich (PDL)' : 'Enrich (PDL)'}
            </button>
            <input type="file" id="pdf-upload-${p.id}" accept=".pdf" style="display:none" onchange="handlePdfUpload(${p.id}, this)">
          </div>
          ${(p.linkedin_pdf_path || p.enriched_at) ? '<div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">' + (p.linkedin_pdf_path ? '<span class="profile-tag" style="background:var(--info-bg);color:var(--info)">PDF Uploaded</span>' : '') + (p.photo_source === 'linkedin_pdf_crop' ? '<span class="profile-tag" style="background:var(--success-bg);color:var(--success)">Photo: LinkedIn PDF</span>' : '') + (p.enriched_at ? '<span class="profile-tag" style="background:var(--success-bg);color:var(--success)">PDL Enriched</span>' : '') + (p.pdl_match_confidence ? '<span class="profile-tag" style="background:var(--info-bg);color:var(--info)">Confidence: ' + Math.round(p.pdl_match_confidence * 100) + '%</span>' : '') + (p.artifact_dossier_markdown ? '<span class="profile-tag" style="background:var(--accent-glow);color:var(--accent)">Artifact Dossier</span>' : '') + '</div>' : ''}
        </div>`;

      if (p.interactions && p.interactions.length) {
        html += `<div class="modal-section"><h4>Recent Interactions</h4>`;
        p.interactions.slice(0, 15).forEach(int => {
          const isEmail = int.type === 'email';
          const icon = isEmail
            ? '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--info)" stroke-width="2" style="flex-shrink:0"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>'
            : '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="2" style="flex-shrink:0"><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.79 19.79 0 0 1 2.12 4.18 2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>';
          const typeLabel = isEmail ? '<span style="color:var(--info);font-size:11px;font-weight:600">EMAIL</span>' : '<span style="color:var(--accent);font-size:11px;font-weight:600">MEETING</span>';
          html += `
            <div class="interaction-item">
              <div style="display:flex;align-items:center;gap:8px">
                ${icon}
                <div class="interaction-item-title" style="flex:1">${int.title || (isEmail ? 'Email' : 'Meeting')}</div>
                ${typeLabel}
              </div>
              <div class="interaction-item-meta">${formatDate(int.date)} ${int.participants ? '&middot; ' + int.participants.join(', ') : ''}</div>
              ${int.summary ? '<div class="interaction-item-summary">' + int.summary + '</div>' : ''}
            </div>`;
        });
        html += '</div>';
      }

      if (p.action_items && p.action_items.length) {
        html += `<div class="modal-section"><h4>Open Action Items</h4>`;
        p.action_items.forEach(item => {
          html += `<div class="interaction-item"><div class="interaction-item-title">${item}</div></div>`;
        });
        html += '</div>';
      }

      // Upcoming Meetings section (from Calendar integration)
      if (p.upcoming_meetings && p.upcoming_meetings.length) {
        html += `<div class="modal-section"><h4>Upcoming Meetings <span style="font-size:10px;color:#60a5fa;margin-left:6px;font-weight:600">${p.upcoming_meetings.length} THIS WEEK</span></h4>`;
        p.upcoming_meetings.forEach(m => {
          const mTime = m.start_time ? new Date(m.start_time).toLocaleString() : '';
          const enrichment = m.enrichment || {};
          html += `
            <div class="interaction-item" style="border-left:3px solid #60a5fa">
              <div style="display:flex;align-items:center;gap:8px">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#60a5fa" stroke-width="2" style="flex-shrink:0"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                <div class="interaction-item-title" style="flex:1">${m.title || 'Meeting'}</div>
                <span style="color:#60a5fa;font-size:11px;font-weight:600">UPCOMING</span>
              </div>
              <div class="interaction-item-meta">${mTime}${m.conference_link ? ' &middot; <a href="' + m.conference_link + '" target="_blank" style="color:var(--accent-light)">Join</a>' : ''}</div>
              ${enrichment.snippet ? '<div class="interaction-item-summary" style="margin-top:8px"><strong style="font-size:11px;color:var(--text-muted)">MEETING CONTEXT:</strong><br>' + enrichment.snippet + '</div>' : ''}
              ${enrichment.open_commitments && enrichment.open_commitments.length ? '<div style="margin-top:6px;font-size:12px;color:var(--warning)"><strong>Open commitments:</strong> ' + enrichment.open_commitments.join('; ') + '</div>' : ''}
              ${enrichment.last_contact_date ? '<div style="font-size:11px;color:var(--text-muted);margin-top:4px">Last email: ' + enrichment.last_contact_date + '</div>' : ''}
            </div>`;
        });
        html += '</div>';
      }

      // Meeting-Prep Brief section (Mode A) — available for ALL contacts
      html += `<div class="modal-section" id="meetingPrepSection${p.id}">
        <h4>Meeting-Prep Brief <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">MODE A — Always Available</span></h4>`;
      if (p.dossier_mode_a_markdown) {
        html += `
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <span style="font-size:12px;color:var(--text-muted)">Generated ${formatRelative(p.dossier_mode_a_generated_at)}</span>
            <button class="btn-research-secondary" onclick="generateMeetingPrep(${p.id})">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
              Refresh
            </button>
          </div>
          <div class="deep-profile-content">${marked.parse(p.dossier_mode_a_markdown)}</div>`;
      } else {
        html += `
          <div style="text-align:center;padding:24px">
            <div style="color:var(--text-muted);font-size:13px;margin-bottom:16px">
              Generate a quick meeting-prep brief from your interaction history.<br>No web search required — always available instantly.
            </div>
            <button class="btn-research" onclick="generateMeetingPrep(${p.id})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              Generate Meeting Prep
            </button>
          </div>`;
      }
      html += '</div>';

      // Artifact Dossier section (PDF-based) — available when PDF uploaded
      if (p.linkedin_pdf_raw_text) {
        html += `<div class="modal-section" id="artifactDossierSection${p.id}">
          <h4>Public Statements & Positions
            <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">ARTIFACT-FIRST — PDF + Meetings</span>
            ${p.linkedin_pdf_path ? '<span class="profile-tag" style="background:var(--info-bg);color:var(--info);margin-left:8px;font-size:10px">PDF</span>' : ''}
          </h4>`;
        if (p.artifact_dossier_markdown) {
          const covPct = p.artifact_dossier_coverage || 0;
          const covColor = covPct >= 85 ? 'var(--success)' : covPct >= 60 ? 'var(--warning)' : 'var(--danger)';
          html += `
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <span style="font-size:12px;color:var(--text-muted)">
                Generated ${formatRelative(p.artifact_dossier_generated_at)}
                <span style="color:${covColor};margin-left:8px">Coverage: ${covPct}%</span>
                <span style="color:var(--text-muted);margin-left:8px">Mode: ${p.artifact_dossier_mode || 'artifact_first'}</span>
              </span>
              <button class="btn-research-secondary" onclick="generateArtifactDossier(${p.id})">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                Regenerate
              </button>
            </div>
            <div class="deep-profile-content">${marked.parse(p.artifact_dossier_markdown)}</div>`;
        } else {
          html += `
            <div style="text-align:center;padding:24px">
              <div style="color:var(--text-muted);font-size:13px;margin-bottom:16px">
                Generate a dossier from your uploaded LinkedIn PDF.<br>No web search needed — works with PDF text + meeting history.
              </div>
              <button class="btn-research" onclick="generateArtifactDossier(${p.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                Generate Artifact Dossier
              </button>
            </div>`;
        }
        html += '</div>';
      }

      // Deep Research Dossier section (Mode B) — available for all contacts
      {
        const drStatus = p.deep_research_status || 'NOT_STARTED';
        const drColor = drStatus === 'SUCCEEDED' ? 'var(--success)' : drStatus === 'FAILED' ? 'var(--danger)' : 'var(--text-muted)';
        html += `<div class="modal-section" id="deepProfileSection${p.id}">
          <h4>Deep Research Dossier <span style="font-size:10px;color:var(--accent-light);margin-left:6px;font-weight:400">MODE B — Web Required</span>
          <span style="font-size:10px;color:${drColor};margin-left:8px;font-weight:600">${drStatus}</span></h4>`;
        if (p.deep_profile) {
          const lockScore = p.entity_lock_score;
          const qaPass = p.qa_passes_all;
          let badges = '';
          if (typeof lockScore === 'number') {
            const lc = lockScore >= 70 ? 'var(--success)' : 'var(--danger)';
            badges += `<span style="font-size:11px;color:${lc};margin-left:8px">\uD83D\uDD12 ${lockScore}/100</span>`;
          }
          if (typeof qaPass === 'boolean') {
            const qc = qaPass ? 'var(--success)' : 'var(--danger)';
            const ql = qaPass ? 'QA PASS' : 'QA FAIL';
            badges += `<span style="font-size:11px;color:${qc};margin-left:8px">${ql}</span>`;
          }
          html += `
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <span style="font-size:12px;color:var(--text-muted)">Generated ${formatRelative(p.deep_profile_generated_at)}${badges}</span>
              <button class="btn-research-secondary" onclick="generateDeepProfile(${p.id}, true)">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                Regenerate
              </button>
            </div>
            <div class="deep-profile-content">${marked.parse(p.deep_profile)}</div>`;
        } else {
          html += `
            <div style="text-align:center;padding:24px">
              <div style="color:var(--text-muted);font-size:13px;margin-bottom:16px">
                Run a full web research dossier with career analysis, public visibility<br>sweep, strategic patterns, conversation playbook, and risk signals.
              </div>
              <button class="btn-research" id="researchBtn${p.id}" onclick="generateDeepProfile(${p.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>
                Run Deep Research
              </button>
            </div>`;
        }
        html += '</div>';
      }

      html += `
        <div style="padding-top:16px;border-top:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn-generate" onclick="closeProfileModal(); $('person').value='${p.name.replace(/'/g, "\\'")}'; ${p.company ? "$('company').value='" + p.company.replace(/'/g, "\\'") + "';" : ''} showPage('generate');">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            Generate Brief for ${p.name.split(' ')[0]}
          </button>
        </div>`;

      $('modalProfileBody').innerHTML = html;
      $('profileModal').classList.add('visible');
    }

    function closeProfileModal() {
      $('profileModal').classList.remove('visible');
    }

    // Close modal on overlay click
    $('profileModal').addEventListener('click', e => {
      if (e.target === $('profileModal')) closeProfileModal();
    });

    // ── Meeting Prep (Mode A) ──
    function scrollToMeetingPrep(profileId) {
      const section = document.getElementById('meetingPrepSection' + profileId);
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    async function generateMeetingPrep(profileId) {
      const section = document.getElementById('meetingPrepSection' + profileId);
      if (!section) return;

      section.innerHTML = `<h4>Meeting-Prep Brief <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">MODE A</span></h4>
        <div style="text-align:center;padding:24px">
          <div class="loading-spinner" style="margin:0 auto 12px"></div>
          <div style="color:var(--text-secondary);font-size:14px">Generating meeting-prep brief...</div>
          <div style="color:var(--text-muted);font-size:12px;margin-top:4px">Uses internal evidence only — no web search needed</div>
        </div>`;

      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/meeting-prep', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || 'Meeting prep generation failed');
        }
        const data = await res.json();
        showToast('Meeting-prep brief generated!', 'success');

        const profile = allProfiles.find(p => p.id === profileId);
        if (profile) {
          profile.dossier_mode_a_markdown = data.brief;
          profile.dossier_mode_a_generated_at = data.generated_at;
        }

        section.innerHTML = `<h4>Meeting-Prep Brief <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">MODE A</span></h4>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <span style="font-size:12px;color:var(--text-muted)">Generated just now</span>
            <button class="btn-research-secondary" onclick="generateMeetingPrep(${profileId})">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
              Refresh
            </button>
          </div>
          <div class="deep-profile-content">${marked.parse(data.brief)}</div>`;
      } catch (e) {
        showToast(e.message);
        section.innerHTML = `<h4>Meeting-Prep Brief <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">MODE A</span></h4>
          <div style="text-align:center;padding:24px">
            <div style="color:var(--danger);font-size:13px;margin-bottom:12px">${e.message}</div>
            <button class="btn-research" onclick="generateMeetingPrep(${profileId})">Try Again</button>
          </div>`;
      }
    }

    // ── Deep Profile Research (Mode B) ──
    function scrollToDeepProfile(profileId) {
      const section = document.getElementById('deepProfileSection' + profileId);
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function scrollToArtifactDossier(profileId) {
      const section = document.getElementById('artifactDossierSection' + profileId);
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function triggerPdfUpload(profileId) {
      const input = document.getElementById('pdf-upload-' + profileId);
      if (input) input.click();
    }

    async function handlePdfUpload(profileId, inputElement) {
      const file = inputElement.files[0];
      if (!file) return;
      if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('Please select a PDF file');
        return;
      }

      // Read file as base64
      const reader = new FileReader();
      reader.onload = async function(e) {
        const base64 = e.target.result.split(',')[1]; // Remove data:...;base64, prefix

        // Show loading state
        const section = document.getElementById('artifactDossierSection' + profileId);
        const parent = inputElement.closest('.modal-section') || inputElement.parentElement;
        const loadingEl = document.createElement('div');
        loadingEl.id = 'pdfUploadLoading' + profileId;
        loadingEl.style.cssText = 'padding:16px;text-align:center;color:var(--info)';
        loadingEl.textContent = 'Uploading and processing PDF...';
        parent.appendChild(loadingEl);

        try {
          const res = await fetch(API_BASE + '/profiles/' + profileId + '/ingest-linkedin-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', ...authHeaders() },
            body: JSON.stringify({ pdf_base64: base64 })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Upload failed');

          // Update loading with results
          loadingEl.innerHTML = '<div style="color:var(--success)">' +
            'PDF processed: ' + data.text_length + ' chars extracted, ' +
            data.sections_found.length + ' sections found' +
            (data.headshot_cropped ? ', headshot cropped' : ', no headshot found') +
            (data.photo_updated ? ' (photo updated)' : '') +
            '</div>';

          // Refresh profiles and reopen modal
          setTimeout(function() {
            loadProfiles();
            loadingEl.remove();
          }, 2000);
        } catch (err) {
          loadingEl.innerHTML = '<div style="color:var(--danger)">Upload failed: ' + err.message + '</div>';
          setTimeout(function() { loadingEl.remove(); }, 5000);
        }
      };
      reader.readAsDataURL(file);
    }

    async function generateArtifactDossier(profileId) {
      const section = document.getElementById('artifactDossierSection' + profileId);
      if (section) {
        section.innerHTML = `
          <h4>Public Statements & Positions <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">ARTIFACT-FIRST</span></h4>
          <div style="text-align:center;padding:24px">
            <div class="loading-spinner"></div>
            <div style="color:var(--text-secondary);font-size:14px;margin-top:12px">Generating artifact dossier from PDF...</div>
          </div>`;
      }

      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/artifact-dossier', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Generation failed');

        if (section) {
          const covPct = data.coverage_pct || 0;
          const covColor = covPct >= 85 ? 'var(--success)' : covPct >= 60 ? 'var(--warning)' : 'var(--danger)';
          section.innerHTML = `
            <h4>Public Statements & Positions <span style="font-size:10px;color:var(--info);margin-left:6px;font-weight:400">ARTIFACT-FIRST</span></h4>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
              <span style="font-size:12px;color:var(--text-muted)">
                Just generated
                <span style="color:${covColor};margin-left:8px">Coverage: ${covPct}%</span>
                <span style="color:var(--text-muted);margin-left:8px">${data.artifact_count} PDF nodes, ${data.meeting_count} meeting nodes</span>
              </span>
              <button class="btn-research-secondary" onclick="generateArtifactDossier(${profileId})">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                Regenerate
              </button>
            </div>
            <div class="deep-profile-content">${marked.parse(data.dossier)}</div>`;
        }
      } catch (err) {
        if (section) {
          section.innerHTML = `
            <h4>Public Statements & Positions</h4>
            <div style="color:var(--danger);padding:16px">Artifact dossier generation failed: ${err.message}</div>
            <button class="btn-research-secondary" onclick="generateArtifactDossier(${profileId})">Retry</button>`;
        }
      }
    }

    async function enrichWithPDL(profileId) {
      const btn = event.target.closest('button');
      const origText = btn ? btn.innerHTML : '';
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<div class="loading-spinner" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></div> Enriching...';
      }

      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/enrich', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Enrichment failed');

        if (data.success) {
          const fields = data.fields_updated || [];
          const conf = data.match_confidence ? Math.round(data.match_confidence * 100) + '%' : '';
          const photoMsg = data.photo_updated ? ' + photo updated' : '';
          if (btn) {
            btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Enriched' + (conf ? ' (' + conf + ')' : '');
            btn.style.borderColor = 'var(--success)';
            btn.style.color = 'var(--success)';
          }
          // Show toast
          const toast = document.createElement('div');
          toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid var(--success);color:var(--success);padding:12px 20px;border-radius:8px;z-index:10000;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
          toast.textContent = 'PDL enrichment: ' + fields.length + ' fields updated' + photoMsg;
          document.body.appendChild(toast);
          setTimeout(function() { toast.remove(); }, 4000);
          // Refresh profiles after short delay to show updated data
          setTimeout(function() { loadProfiles(); }, 1500);
        } else {
          throw new Error(data.error || 'No match found');
        }
      } catch (err) {
        if (btn) {
          btn.innerHTML = origText;
          btn.disabled = false;
          btn.style.borderColor = 'var(--danger)';
          btn.style.color = 'var(--danger)';
        }
        const toast = document.createElement('div');
        toast.style.cssText = 'position:fixed;bottom:24px;right:24px;background:var(--bg-card);border:1px solid var(--danger);color:var(--danger);padding:12px 20px;border-radius:8px;z-index:10000;font-size:13px;box-shadow:0 4px 12px rgba(0,0,0,0.3)';
        toast.textContent = 'PDL enrichment failed: ' + err.message;
        document.body.appendChild(toast);
        setTimeout(function() { toast.remove(); }, 5000);
      }
    }

    function renderEntityLockHtml(lock) {
      if (!lock) return '';
      const score = lock.entity_lock_score || 0;
      const locked = lock.is_locked;
      const color = locked ? 'var(--success)' : score >= 50 ? 'var(--warning, #f0ad4e)' : 'var(--danger)';
      const label = locked ? 'LOCKED' : score >= 50 ? 'PARTIAL' : 'NOT LOCKED';
      let html = `<div style="border:1px solid ${color};border-radius:8px;padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.2)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <strong style="font-size:13px">Entity Lock</strong>
          <span style="font-size:12px;font-weight:600;color:${color};padding:2px 8px;border:1px solid ${color};border-radius:4px">${score}/100 ${label}</span>
        </div>`;
      if (lock.disambiguation_risks && lock.disambiguation_risks.length > 0) {
        html += `<div style="color:var(--danger);font-size:12px;margin-bottom:6px">${lock.disambiguation_risks[0]}</div>`;
      }
      const signals = lock.signals || {};
      // LinkedIn: show both "URL present" and "verified via retrieval"
      const checks = [
        ['LinkedIn URL present', signals.linkedin_url_present],
        ['LinkedIn verified via retrieval', signals.linkedin_verified_by_retrieval],
        ['Meeting confirmed', signals.meeting_confirmed],
        ['Company match', signals.company_match],
        ['Title match', signals.title_match],
        ['Location match', signals.location_match],
        ['Multiple sources agree', signals.multiple_sources_agree],
      ];
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px">';
      for (const [lbl, ok] of checks) {
        const ic = ok ? '\u2713' : '\u2717';
        const c = ok ? 'var(--success)' : 'var(--text-muted)';
        html += `<span style="font-size:11px;color:${c}">${ic} ${lbl}</span>`;
      }
      html += '</div></div>';
      return html;
    }

    function renderQaReportHtml(qa) {
      if (!qa) return '';
      const passesAll = qa.passes_all;
      const borderColor = passesAll ? 'var(--success)' : 'var(--danger)';
      const statusLabel = passesAll ? 'ALL GATES PASS' : 'GATES FAILED';
      let html = `<div style="border:1px solid ${borderColor};border-radius:8px;padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.2)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;cursor:pointer" onclick="this.parentElement.querySelector('.qa-details').classList.toggle('hidden')">
          <strong style="font-size:13px">QA Report</strong>
          <span style="font-size:12px;font-weight:600;color:${borderColor};padding:2px 8px;border:1px solid ${borderColor};border-radius:4px">${statusLabel}</span>
        </div>
        <div style="display:flex;gap:16px;font-size:12px;margin-bottom:8px">
          <span>Genericness: <strong>${qa.genericness_score}/100</strong></span>
          <span>Evidence: <strong>${qa.evidence_coverage_pct}%</strong></span>
          <span>Contradictions: <strong>${qa.contradictions}</strong></span>
        </div>`;
      if (qa.hallucination_risk_flags && qa.hallucination_risk_flags.length > 0) {
        html += '<div style="font-size:11px;color:var(--danger);margin-bottom:4px">';
        for (const f of qa.hallucination_risk_flags) {
          html += `<div>\u26A0 ${f}</div>`;
        }
        html += '</div>';
      }
      if (qa.markdown) {
        html += `<div class="qa-details hidden" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:12px">${marked.parse(qa.markdown)}</div>`;
      }
      html += '</div>';
      return html;
    }

    function renderSearchPlanHtml(plan) {
      if (!plan || plan.length === 0) return '';
      let html = `<div style="border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.2)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;cursor:pointer" onclick="this.parentElement.querySelector('.plan-details').classList.toggle('hidden')">
          <strong style="font-size:13px">Search Queries (${plan.length})</strong>
          <span style="font-size:11px;color:var(--text-muted)">click to expand</span>
        </div>
        <div class="plan-details hidden" style="font-size:12px">`;
      for (const q of plan) {
        html += `<div style="margin-bottom:8px;padding:6px;background:rgba(0,0,0,0.3);border-radius:4px">
          <div style="font-family:monospace;font-size:11px;color:var(--accent-light);word-break:break-all">${q.query}</div>
          <div style="color:var(--text-muted);font-size:11px;margin-top:2px">${q.category} \u2014 ${q.rationale}</div>
        </div>`;
      }
      html += '</div></div>';
      return html;
    }

    function renderVisibilityReportHtml(vis) {
      if (!vis) return '';
      const executed = vis.sweep_executed;
      const borderColor = executed ? 'var(--info)' : 'var(--danger)';
      const statusLabel = executed ? `SWEEP EXECUTED (${vis.total_results} results)` : 'SWEEP NOT EXECUTED';
      let html = `<div style="border:1px solid ${borderColor};border-radius:8px;padding:12px;margin-bottom:12px;background:rgba(0,0,0,0.2)">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;cursor:pointer" onclick="this.parentElement.querySelector('.vis-details').classList.toggle('hidden')">
          <strong style="font-size:13px">Public Visibility Sweep</strong>
          <span style="font-size:12px;font-weight:600;color:${borderColor};padding:2px 8px;border:1px solid ${borderColor};border-radius:4px">${statusLabel}</span>
        </div>
        <div style="display:flex;gap:12px;font-size:12px;margin-bottom:8px;flex-wrap:wrap">`;
      const checks = [
        ['TED/TEDx', vis.ted_tedx_found],
        ['Podcast/Webinar', vis.podcast_webinar_found],
        ['Conference/Keynote', vis.conference_keynote_found],
      ];
      for (const [lbl, found] of checks) {
        const c = found ? 'var(--success)' : 'var(--text-muted)';
        const ic = found ? '\u2713' : '\u2717';
        html += `<span style="font-size:11px;color:${c}">${ic} ${lbl}</span>`;
      }
      html += '</div>';
      if (vis.results_by_category) {
        html += '<div class="vis-details hidden" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:12px">';
        const catLabels = {ted:'TED',tedx:'TEDx',keynote:'Keynote',conference:'Conference',summit:'Summit',podcast:'Podcast',webinar:'Webinar',youtube_talk:'YouTube Talk',panel:'Panel',interview_video:'Interview Video'};
        for (const [cat, count] of Object.entries(vis.results_by_category)) {
          const lbl = catLabels[cat] || cat;
          const c = count > 0 ? 'var(--success)' : 'var(--text-muted)';
          html += `<div style="display:flex;justify-content:space-between;padding:2px 0"><span>${lbl}</span><span style="color:${c};font-weight:600">${count} results</span></div>`;
        }
        html += '</div>';
      }
      html += '</div>';
      return html;
    }

    function renderRetrievalLedgerHtml(data) {
      const ledgerCount = data.retrieval_ledger_count || 0;
      const visCount = data.visibility_ledger_count || 0;
      const pdlEnriched = data.pdl_enriched;
      const drStatus = data.deep_research_status || 'UNKNOWN';
      const fc = data.fail_closed_status || {};
      const gatesPassed = fc.gates_passed;
      const serpError = fc.serp_error || '';

      const statusColor = drStatus === 'SUCCEEDED' ? 'var(--success)' : drStatus === 'FAILED' ? 'var(--danger)' : 'var(--warning)';
      const ledgerColor = ledgerCount > 0 ? 'var(--success)' : 'var(--danger)';
      const visColor = visCount > 0 ? 'var(--success)' : 'var(--danger)';

      let html = `<div style="background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-md);padding:14px;margin:8px 0">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <span style="font-size:13px;font-weight:600">Deep Research Status</span>
          <span style="font-size:11px;font-weight:600;color:${statusColor};background:${statusColor}20;padding:2px 8px;border-radius:4px">${drStatus}</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px">
          <div style="background:var(--bg-card);border-radius:6px;padding:8px;text-align:center">
            <div style="color:var(--text-muted);margin-bottom:2px">Retrieval Ledger</div>
            <div style="font-weight:700;font-size:18px;color:${ledgerColor}">${ledgerCount}</div>
            <div style="color:var(--text-muted)">queries logged</div>
          </div>
          <div style="background:var(--bg-card);border-radius:6px;padding:8px;text-align:center">
            <div style="color:var(--text-muted);margin-bottom:2px">Visibility Sweep</div>
            <div style="font-weight:700;font-size:18px;color:${visColor}">${visCount}</div>
            <div style="color:var(--text-muted)">visibility queries</div>
          </div>
          <div style="background:var(--bg-card);border-radius:6px;padding:8px;text-align:center">
            <div style="color:var(--text-muted);margin-bottom:2px">PDL Enriched</div>
            <div style="font-weight:700;font-size:18px;color:${pdlEnriched ? 'var(--success)' : 'var(--text-muted)'}">${pdlEnriched ? 'Yes' : 'No'}</div>
          </div>
        </div>`;

      if (serpError) {
        html += `<div style="margin-top:8px;padding:6px 10px;background:var(--danger-bg);border-radius:6px;font-size:11px;color:var(--danger)">${serpError}</div>`;
      }

      html += '</div>';
      return html;
    }

    async function generateDeepProfile(profileId, regenerate) {
      const section = document.getElementById('deepProfileSection' + profileId);
      if (!section) return;

      // Show loading state with progress
      section.innerHTML = `<h4>Intelligence Dossier</h4>
        <div style="text-align:center;padding:40px">
          <div class="loading-spinner" style="margin:0 auto 16px"></div>
          <div style="color:var(--text-secondary);font-size:14px;font-weight:500" id="drProgress${profileId}">Starting deep research...</div>
          <div style="color:var(--text-muted);font-size:12px;margin-top:6px">PDL enrich \u2192 Web search \u2192 Visibility sweep \u2192 Entity lock \u2192 LLM synthesis \u2192 QA gates</div>
          <div style="color:var(--text-muted);font-size:12px;margin-top:2px">This may take 30\u201390 seconds</div>
        </div>`;

      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/deep-research', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          throw new Error(err.detail || 'Deep research failed');
        }
        const data = await res.json();

        const isSuccess = data.deep_research_status === 'SUCCEEDED';
        showToast(isSuccess ? 'Intelligence dossier generated!' : 'Deep research completed with issues', isSuccess ? 'success' : 'warning');

        // Update local profile data
        const profile = allProfiles.find(p => p.id === profileId);
        if (profile) {
          profile.deep_profile = data.deep_profile;
          profile.deep_profile_generated_at = data.generated_at;
          profile.deep_research_status = data.deep_research_status;
          profile.entity_lock_score = (data.entity_lock || {}).entity_lock_score;
          profile.qa_passes_all = (data.qa_report || {}).passes_all;
          profile.qa_report_data = data.qa_report;
          profile.entity_lock_data = data.entity_lock;
          profile.search_plan = data.search_plan;
          profile.visibility_report = data.visibility_report;
        }

        // Render the result with retrieval ledger + entity lock + QA + visibility + dossier
        section.innerHTML = `<h4>Intelligence Dossier</h4>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
            <span style="font-size:12px;color:var(--text-muted)">Generated just now</span>
            <button class="btn-research-secondary" onclick="generateDeepProfile(${profileId}, true)">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
              Regenerate
            </button>
          </div>
          ${renderRetrievalLedgerHtml(data)}
          ${renderEntityLockHtml(data.entity_lock)}
          ${renderVisibilityReportHtml(data.visibility_report)}
          ${data.qa_report ? renderQaReportHtml(data.qa_report) : ''}
          ${renderSearchPlanHtml(data.search_plan)}
          <div class="deep-profile-content">${marked.parse(data.deep_profile || '(No dossier generated)')}</div>`;
      } catch (e) {
        showToast(e.message);
        section.innerHTML = `<h4>Intelligence Dossier</h4>
          <div style="text-align:center;padding:24px">
            <div style="color:var(--danger);font-size:13px;margin-bottom:12px">${e.message}</div>
            <button class="btn-research" onclick="generateDeepProfile(${profileId})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/><path d="M11 8v6M8 11h6"/></svg>
              Try Again
            </button>
          </div>`;
      }
    }

    // ── Recent briefs ──
    async function loadRecent() {
      try {
        const res = await fetch(API_BASE + '/briefs/recent', { headers: authHeaders() });
        const data = await res.json();
        const list = $('recentList');

        if (!data.length) {
          list.innerHTML = '<li class="empty-state">No briefs generated yet.</li>';
          return;
        }

        list.innerHTML = data.map((b, i) => `
          <li class="recent-item" onclick="loadBriefFromRecent(${i})" data-index="${i}">
            <div class="recent-item-title">${b.person || b.company || 'Brief'}</div>
            <div class="recent-item-meta">
              <span>${formatDate(b.created_at)}</span>
              ${b.company ? '<span>' + b.company + '</span>' : ''}
              <span class="confidence-badge ${confidenceClass(b.confidence_score)}">${Math.round(b.confidence_score * 100)}%</span>
            </div>
          </li>
        `).join('');

        window._recentBriefs = data;
      } catch (e) {
        $('recentList').innerHTML = '<li class="empty-state">Could not load recent briefs.</li>';
      }
    }

    function loadBriefFromRecent(index) {
      const b = window._recentBriefs[index];
      if (!b) return;
      document.querySelectorAll('.recent-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`[data-index="${index}"]`)?.classList.add('active');
      currentBrief = b.brief_json ? (typeof b.brief_json === 'string' ? JSON.parse(b.brief_json) : b.brief_json) : null;
      currentMarkdown = b.brief_markdown || '';
      displayBrief(b.confidence_score);
    }

    // ── Generate ──
    async function generateBrief() {
      const person = $('person').value.trim();
      const company = $('company').value.trim();
      const topic = $('topic').value.trim();
      const meetingWhen = $('meetingWhen').value;
      const skipIngestion = $('skipIngestion').checked;

      if (!person && !company) {
        showToast('Enter at least a person or company name.');
        return;
      }

      const btn = $('generateBtn');
      btn.disabled = true;
      btn.innerHTML = '<div class="spinner"></div> Generating...';

      try {
        const body = {};
        if (person) body.person = person;
        if (company) body.company = company;
        if (topic) body.topic = topic;
        if (meetingWhen) body.meeting_when = meetingWhen.replace('T', ' ');
        body.skip_ingestion = skipIngestion;

        const res = await fetch(API_BASE + '/brief', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: res.statusText }));
          throw new Error(err.detail || 'Brief generation failed');
        }

        const data = await res.json();
        currentBrief = data.brief;
        currentMarkdown = data.markdown;
        displayBrief(data.confidence_score);
        loadRecent();
      } catch (e) {
        showToast(e.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Generate Brief`;
      }
    }

    // ── Display ──
    function displayBrief(confidenceScore) {
      $('emptyState').style.display = 'none';
      $('briefToolbar').style.display = 'flex';
      $('confidenceMeter').style.display = 'flex';

      const pct = Math.round((confidenceScore || 0) * 100);
      const fill = $('meterFill');
      fill.style.width = pct + '%';
      fill.style.background = confidenceColor(confidenceScore || 0);
      $('meterLabel').textContent = pct + '%';
      $('meterLabel').style.color = confidenceColor(confidenceScore || 0);

      $('renderedView').innerHTML = marked.parse(currentMarkdown || '*No markdown available*');
      $('jsonView').innerHTML = currentBrief ? syntaxHighlight(currentBrief) : 'No JSON data';
      switchView(currentView);
    }

    function switchView(view) {
      currentView = view;
      $('tabRendered').className = view === 'rendered' ? 'tab-btn active' : 'tab-btn';
      $('tabJson').className = view === 'json' ? 'tab-btn active' : 'tab-btn';
      $('renderedView').style.display = view === 'rendered' ? 'block' : 'none';
      $('jsonView').style.display = view === 'json' ? 'block' : 'none';
    }

    // ── Actions ──
    function copyBrief() {
      const text = currentView === 'rendered' ? currentMarkdown : JSON.stringify(currentBrief, null, 2);
      navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard!', 'success'));
    }

    function downloadBrief() {
      const isJson = currentView === 'json';
      const content = isJson ? JSON.stringify(currentBrief, null, 2) : currentMarkdown;
      const ext = isJson ? 'json' : 'md';
      const mime = isJson ? 'application/json' : 'text/markdown';
      const name = (currentBrief?.header?.person || currentBrief?.header?.company || 'brief').replace(/[^a-zA-Z0-9]/g, '_');
      const blob = new Blob([content], { type: mime });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `brief_${name}.${ext}`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ── LinkedIn Review ──
    let pendingReviews = [];
    let selectedCandidates = {}; // profileId -> candidate index

    async function loadPendingReviews() {
      try {
        const res = await fetch(API_BASE + '/profiles/pending-review', { headers: authHeaders() });
        if (!res.ok) return;
        pendingReviews = await res.json();
        renderPendingReviews();
        // Update badge
        if (pendingReviews.length > 0) {
          $('reviewBadge').style.display = 'inline-flex';
          $('reviewBadge').textContent = pendingReviews.length;
        } else {
          $('reviewBadge').style.display = 'none';
        }
      } catch (e) {}
    }

    function renderPendingReviews() {
      const container = $('reviewList');
      $('reviewCount').textContent = pendingReviews.length
        ? pendingReviews.length + ' contact' + (pendingReviews.length > 1 ? 's' : '') + ' need review'
        : '';

      if (!pendingReviews.length) {
        container.innerHTML = `
          <div class="review-empty">
            <div style="margin-bottom: 12px; opacity: 0.3;">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            </div>
            <div class="empty-title">All caught up</div>
            <div class="empty-subtitle">No contacts need LinkedIn profile review right now. When a sync finds contacts that can't be matched automatically, they'll appear here.</div>
          </div>`;
        return;
      }

      container.innerHTML = pendingReviews.map((p, pi) => {
        const candidates = p.linkedin_candidates || [];
        const selectedIdx = selectedCandidates[p.id];
        const isNoMatch = p.linkedin_status === 'no_match' || candidates.length === 0;
        const defaultSearch = [p.name, p.company].filter(Boolean).join(' @ ');

        const headerHtml = `
          <div class="review-card-header">
            ${avatarHtml(p.name, p.email, 48, p.photo_url || getCandidatePhoto(p), p.linkedin_url, p.id)}
            <div class="review-card-info">
              <div class="review-card-name">${p.name}</div>
              <div class="review-card-meta">
                ${p.company ? p.company + ' &middot; ' : ''}${p.email || ''}
                ${p.meeting_count ? ' &middot; ' + p.meeting_count + ' meeting' + (p.meeting_count > 1 ? 's' : '') : ''}
              </div>
            </div>
          </div>`;

        const candidatesHtml = candidates.length ? `
          <div class="review-label">Select the correct LinkedIn profile</div>
          <div class="candidates-grid">
            ${candidates.map((c, ci) => `
              <div class="candidate-card ${selectedIdx === ci ? 'selected' : ''}" onclick="selectCandidate(${p.id}, ${ci})">
                <div class="candidate-top">
                  ${c.photo_url
                    ? '<div class="profile-avatar" style="width:40px;height:40px"><img class="profile-avatar-img" src="' + c.photo_url + '" alt="" onerror="this.parentElement.innerHTML=\'' + getInitials(c.name) + '\'"></div>'
                    : '<div class="profile-avatar ' + avatarClass(c.name) + '" style="width:40px;height:40px;font-size:16px">' + getInitials(c.name) + '</div>'
                  }
                  <div>
                    <div class="candidate-name">${c.name || 'Unknown'}${c.recommended ? ' <span class="profile-tag" style="background:var(--success-bg);color:var(--success);font-size:10px;margin-left:6px">Best match</span>' : ''}</div>
                    <div class="candidate-title">${c.title ? c.title + (c.company_name ? ' @ ' + c.company_name : '') : (c.company_name || '')}</div>
                  </div>
                </div>
                <div class="candidate-details">
                  ${c.headline ? '<div class="candidate-detail">' + c.headline + '</div>' : ''}
                  ${c.city || c.state ? '<div class="candidate-detail"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg> ' + [c.city, c.state].filter(Boolean).join(', ') + '</div>' : ''}
                  ${c.company_industry ? '<div class="candidate-detail">' + c.company_industry + (c.company_size ? ' &middot; ~' + c.company_size.toLocaleString() + ' employees' : '') + '</div>' : ''}
                </div>
                ${c.linkedin_url ? '<a class="candidate-li-link" href="' + c.linkedin_url + '" target="_blank" rel="noopener" onclick="event.stopPropagation()"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"/></svg> View profile</a>' : ''}
              </div>
            `).join('')}
          </div>
          <div class="review-actions">
            <button class="btn-confirm" id="confirmBtn${p.id}" ${selectedIdx === undefined ? 'disabled' : ''} onclick="confirmLinkedIn(${p.id})">
              Confirm Selection
            </button>
            <button class="btn-none" onclick="rejectLinkedIn(${p.id})">None of the above</button>
          </div>` : `
          <div class="review-label">No automatic matches found</div>`;

        const searchHtml = `
          <div class="${candidates.length ? 'manual-or' : ''}" style="margin-top:${candidates.length ? '12' : '4'}px;margin-bottom:8px;color:var(--text-muted);font-size:12px">${candidates.length ? 'Or search manually' : 'Search for this person'}</div>
          <div class="search-row">
            <input type="text" id="searchInput${p.id}" placeholder="Name @ Company (e.g. Jane Doe @ Acme)" value="${defaultSearch}" onkeydown="if(event.key==='Enter')searchLinkedIn(${p.id})" />
            <button id="searchBtn${p.id}" onclick="searchLinkedIn(${p.id})">Search</button>
          </div>
          <div class="manual-or" style="margin-bottom:8px">Or paste LinkedIn URL</div>
          <div class="search-row">
            <input type="text" id="manualUrl${p.id}" placeholder="https://www.linkedin.com/in/..." onkeydown="if(event.key==='Enter')setManualLinkedIn(${p.id})" />
            <button onclick="setManualLinkedIn(${p.id})">Save</button>
          </div>
          ${isNoMatch ? '<div class="review-actions"><button class="btn-none" onclick="dismissProfile(' + p.id + ')">Skip this contact</button></div>' : ''}`;

        return `
        <div class="review-card" id="reviewCard${p.id}">
          ${headerHtml}
          ${candidatesHtml}
          ${searchHtml}
        </div>`;
      }).join('');
    }

    function selectCandidate(profileId, candidateIndex) {
      selectedCandidates[profileId] = candidateIndex;
      // Re-render just the card's candidate selection states
      const card = document.getElementById('reviewCard' + profileId);
      if (card) {
        card.querySelectorAll('.candidate-card').forEach((el, i) => {
          el.classList.toggle('selected', i === candidateIndex);
        });
        const btn = document.getElementById('confirmBtn' + profileId);
        if (btn) btn.disabled = false;
      }
    }

    async function confirmLinkedIn(profileId) {
      const idx = selectedCandidates[profileId];
      if (idx === undefined) return;
      const btn = document.getElementById('confirmBtn' + profileId);
      if (btn) { btn.disabled = true; btn.textContent = 'Saving...'; }
      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/confirm-linkedin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ candidate_index: idx }),
        });
        if (!res.ok) throw new Error('Failed to confirm');
        showToast('LinkedIn profile confirmed!', 'success');
        delete selectedCandidates[profileId];
        pendingReviews = pendingReviews.filter(p => p.id !== profileId);
        renderPendingReviews();
        if (pendingReviews.length > 0) {
          $('reviewBadge').textContent = pendingReviews.length;
        } else {
          $('reviewBadge').style.display = 'none';
        }
        // Refresh profiles to show new photo/linkedin
        loadProfiles();
      } catch (e) {
        showToast(e.message);
        if (btn) { btn.disabled = false; btn.textContent = 'Confirm Selection'; }
      }
    }

    async function searchLinkedIn(profileId) {
      const input = document.getElementById('searchInput' + profileId);
      const btn = document.getElementById('searchBtn' + profileId);
      const query = (input ? input.value : '').trim();
      if (!query) { showToast('Enter a search query'); return; }
      if (btn) { btn.disabled = true; btn.textContent = 'Searching...'; }
      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/search-linkedin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ query: query }),
        });
        if (!res.ok) throw new Error('Search failed');
        const data = await res.json();
        if (!data.candidates || data.candidates.length === 0) {
          showToast('No results found — try different terms');
          if (btn) { btn.disabled = false; btn.textContent = 'Search'; }
          return;
        }
        showToast(data.candidates.length + ' candidate(s) found', 'success');
        // Update the local data and re-render
        const profile = pendingReviews.find(p => p.id === profileId);
        if (profile) {
          profile.linkedin_candidates = data.candidates;
          profile.linkedin_status = 'pending_review';
        }
        delete selectedCandidates[profileId];
        renderPendingReviews();
      } catch (e) {
        showToast(e.message);
        if (btn) { btn.disabled = false; btn.textContent = 'Search'; }
      }
    }

    async function setManualLinkedIn(profileId) {
      const input = document.getElementById('manualUrl' + profileId);
      const url = (input ? input.value : '').trim();
      if (!url) { showToast('Paste a LinkedIn URL'); return; }
      if (!url.includes('linkedin.com')) { showToast('That doesn\'t look like a LinkedIn URL'); return; }
      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/set-linkedin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ linkedin_url: url }),
        });
        if (!res.ok) throw new Error('Failed to save');
        showToast('LinkedIn URL saved!', 'success');
        pendingReviews = pendingReviews.filter(p => p.id !== profileId);
        renderPendingReviews();
        if (pendingReviews.length > 0) {
          $('reviewBadge').textContent = pendingReviews.length;
        } else {
          $('reviewBadge').style.display = 'none';
        }
        loadProfiles();
      } catch (e) {
        showToast(e.message);
      }
    }

    async function dismissProfile(profileId) {
      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/confirm-linkedin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ candidate_index: -1 }),
        });
        if (!res.ok) throw new Error('Failed to update');
        showToast('Contact skipped', 'success');
        pendingReviews = pendingReviews.filter(p => p.id !== profileId);
        renderPendingReviews();
        if (pendingReviews.length > 0) {
          $('reviewBadge').textContent = pendingReviews.length;
        } else {
          $('reviewBadge').style.display = 'none';
        }
      } catch (e) {
        showToast(e.message);
      }
    }

    async function rejectLinkedIn(profileId) {
      try {
        const res = await fetch(API_BASE + '/profiles/' + profileId + '/confirm-linkedin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ candidate_index: -1 }),
        });
        if (!res.ok) throw new Error('Failed to update');
        showToast('Marked as no match', 'success');
        delete selectedCandidates[profileId];
        // Keep the profile in the list so user can search manually
        const profile = pendingReviews.find(p => p.id === profileId);
        if (profile) {
          profile.linkedin_status = 'no_match';
          profile.linkedin_candidates = [];
        }
        renderPendingReviews();
        if (pendingReviews.length > 0) {
          $('reviewBadge').textContent = pendingReviews.length;
        } else {
          $('reviewBadge').style.display = 'none';
        }
      } catch (e) {
        showToast(e.message);
      }
    }

    // ── Init ──
    checkHealth();
    loadStats();
    loadNextSteps();
    loadRecent();
    loadPendingReviews();
    setInterval(checkHealth, 30000);
    setInterval(loadStats, 60000);

    ['person', 'company'].forEach(id => {
      $(id).addEventListener('keydown', e => { if (e.key === 'Enter') generateBrief(); });
    });

    // Escape key closes modal
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeProfileModal(); });
  </script>
</body>
</html>
